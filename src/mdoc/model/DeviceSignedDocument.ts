import { DataItem } from '../../cbor/DataItem';
import { DeviceSigned, DocType, IssuerSigned } from './types';
import { IssuerSignedDocument } from './IssuerSignedDocument';

/**
 * Represents a device signed document.
 *
 * Note: You don't need to instantiate this class.
 * This is the return type of the parser and it will be generated by the DeviceResponse builder.
 */
export class DeviceSignedDocument extends IssuerSignedDocument {
  constructor(
    docType: DocType,
    issuerSigned: IssuerSigned,
    public readonly deviceSigned: DeviceSigned,
  ) {
    super(docType, issuerSigned);
  }

  prepare(): Map<string, any> {
    const doc = super.prepare();
    const deviceSignature = this.deviceSigned.deviceAuth.deviceSignature?.getContentForEncoding();
    const deviceMac = this.deviceSigned.deviceAuth.deviceMac?.getContentForEncoding();
    // detach payload
    if (deviceMac) {
      deviceMac[2] = null;
    }
    if (deviceSignature) {
      deviceSignature[2] = null;
    }

    doc.set('deviceSigned', {
      ...this.deviceSigned,
      nameSpaces: DataItem.fromData(this.deviceSigned.nameSpaces),
      deviceAuth: {
        ...this.deviceSigned.deviceAuth,
        ...(deviceSignature ? { deviceSignature } : {}),
        ...(deviceMac ? { deviceMac } : {}),
      },
    });
    return doc;
  }

  /**
   * Helper method to get the values in a namespace as a JS object.
   *
   * @param {string} namespace - The namespace to add.
   * @returns {Record<string, any>} - The values in the namespace as an object
   */
  getDeviceNameSpace(namespace: string): Record<string, any> {
    return this.deviceSigned.nameSpaces[namespace];
  }
}
